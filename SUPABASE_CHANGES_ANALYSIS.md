# Supabaseå‘¨ã‚Šã®å¤‰æ›´åˆ†æ

## ğŸ” ç¢ºèªã•ã‚ŒãŸå¤‰æ›´ç‚¹

### 1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œ
- **å¾“æ¥**: `access_passwords`ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ èªè¨¼
- **ç¾åœ¨**: Supabase Authãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®å¤‰æ›´
- **ç®¡ç†ç”»é¢**: `auth.users`ã®UUIDãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹**: `id: string (UUID)`, `email: string`å½¢å¼ã«å¤‰æ›´

### 3. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¤‰æ›´

#### ä¿®æ­£æ¸ˆã¿
- âœ… `/api/admin/users` - Supabase Auth adminæ©Ÿèƒ½ä½¿ç”¨
- âœ… `/api/auth/signup` - Supabase Auth createUserä½¿ç”¨  
- âœ… `/api/user` - Supabase Auth getUserByIdä½¿ç”¨

#### è¦ç¢ºèª/ä¿®æ­£ãŒå¿…è¦
- â“ `/api/auth/route.ts` - å¾“æ¥ã®access_passwordsèªè¨¼ãŒæ®‹å­˜
- â“ Dashboard page - sessionStorage('currentUserId')ä½¿ç”¨
- â“ Canvas components - å¾“æ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå½¢å¼ä½¿ç”¨

## ğŸš¨ äº’æ›æ€§ã®å•é¡Œ

### 1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®é‡è¤‡
```typescript
// å¾“æ¥æ–¹å¼ï¼ˆ/api/auth/route.tsï¼‰
const { userId, password } = await request.json();
// access_passwordsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯

// æ–°æ–¹å¼ï¼ˆ/login/page.tsxï¼‰  
const { data, error } = await supabase.auth.signInWithPassword({
  email: formData.email,
  password: formData.password
});
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ä¸æ•´åˆ
- **å¾“æ¥**: `user-xxxxx` å½¢å¼ã®ã‚«ã‚¹ã‚¿ãƒ ID
- **æ–°æ–¹å¼**: UUIDãƒ™ãƒ¼ã‚¹ã®auth.users.id

### 3. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¸ä¸€è‡´
```typescript
// å¾“æ¥ã®Userå‹
interface User {
  id: number;
  user_id: string;  // access_passwordsã¨ã®é€£æº
  plan: 'free' | 'premium';
  canvas_count: number;
  export_count: number;
}

// æ–°ã—ã„Userå‹  
interface User {
  id: string; // auth.usersã®id(UUID)
  email: string;
  created_at?: string;
  last_sign_in_at?: string;
}
```

## ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€

### é«˜å„ªå…ˆåº¦
1. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±ä¸€**
   - `/api/auth/route.ts` ã®æ›´æ–°ã¾ãŸã¯å‰Šé™¤
   - Dashboard ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ä¿®æ­£

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†**
   - ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’profilesãƒ†ãƒ¼ãƒ–ãƒ«ç­‰ã§ç®¡ç†
   - ã‚­ãƒ£ãƒ³ãƒã‚¹æ•°ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ•°ã®ç®¡ç†æ–¹å¼ç¢ºç«‹

3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - sessionStorage('currentUserId') â†’ Supabase Auth sessionä½¿ç”¨

### ä¸­å„ªå…ˆåº¦
1. **Canvasæ©Ÿèƒ½ã®æ›´æ–°**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå½¢å¼ã®çµ±ä¸€
   - Supabase Storageæ¨©é™ã®èª¿æ•´

2. **Notionè¨­å®šç®¡ç†**
   - access_passwordsã®notion_*ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â†’ profilesç§»è¡Œ

### ä½å„ªå…ˆåº¦
1. **ç®¡ç†ç”»é¢ã®æ©Ÿèƒ½æ‹¡å¼µ**
   - ãƒ—ãƒ©ãƒ³ç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…
   - ä½¿ç”¨é‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

## ğŸ“‹ æ¨å¥¨ä¿®æ­£æ‰‹é †

### Phase 1: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±ä¸€
1. å¾“æ¥ã®èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
2. å…¨ãƒšãƒ¼ã‚¸ã§Supabase Authä½¿ç”¨
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®çµ±ä¸€

### Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
1. profilesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
2. ãƒ—ãƒ©ãƒ³ãƒ»ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
3. Notionè¨­å®šç§»è¡Œ

### Phase 3: æ¨©é™ãƒ»RLSèª¿æ•´
1. Storage RLSãƒãƒªã‚·ãƒ¼æ›´æ–°
2. ãƒ†ãƒ¼ãƒ–ãƒ«RLSãƒãƒªã‚·ãƒ¼æ›´æ–°
3. adminæ¨©é™èª¿æ•´

## âš ï¸ é‡è¦ãªæ³¨æ„ç‚¹

1. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**: æ—¢å­˜ã®access_passwordsãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œæˆ¦ç•¥ãŒå¿…è¦
2. **ä¸‹ä½äº’æ›æ€§**: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³ç¶™ç¶šæ€§
3. **æ¨©é™ç®¡ç†**: Service Roleä½¿ç”¨ç®‡æ‰€ã®æ•´ç†
4. **ãƒ†ã‚¹ãƒˆ**: èªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®ãƒ†ã‚¹ãƒˆå¿…é ˆ

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. ç¾åœ¨ã®èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèª
2. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»ã®ç­–å®š  
3. æ®µéšçš„ãªä¿®æ­£å®Ÿè£…
4. åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ